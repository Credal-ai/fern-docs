imports:
  commons: ./commons.yml
service:
  base-path: /v0/search
  auth: true
  endpoints:
    searchDocumentCatalog:
      path: /searchDocumentCatalog
      docs: Search across all documents uploaded to Credal using the document metadata and contents.
      method: POST
      request:
        name: SearchDocumentCatalogRequest
        body:
          properties:
            searchQuery:
              type: string
            searchOptions:
              type: optional<CatalogSearchOptions>
      response: SearchDocumentCatalogResponse
      examples:
        - name: searchDocumentCatalogExample
          request:
            searchQuery: "ABC Corp"
            searchOptions:
              maxResults: 5
          response:
            body:
              searchId: 76b4cdda-5d5c-11ee-b268-cb249f5be4f9
              results:
                - documentId: 82e4b12a-6990-45d4-8ebd-85c00e030c24
                  documentName: "ABC Corp - Initial meeting transcript"
                - documentId: c7e1283b-4f66-4caf-828d-cf03841e0324
                  documentName: "ABC Corp - Demo meeting transcript"
    searchDocumentCollection:
      path: /searchDocumentCollection
      docs: Search across all documents in a document collection using the document metadata and contents.
      method: POST
      request:
        name: SearchDocumentCollectionRequest
        body:
          properties:
            documentCollectionId:
              type: uuid
            searchQuery:
              type: string
            metadataFilterExpression:
              type: optional<string>
              docs: |
                The metadata search expression to filter the documents in the document collection.
            searchOptions:
              type: optional<DocumentCollectionSearchOptions>
      response: SearchDocumentCollectionResponse
      examples:
        - name: searchDocumentCollectionExample
          request:
            documentCollectionId: 82e4b12a-6990-45d4-8ebd-85c00e030c24
            searchQuery: "ABC Corp"
            metadataFilterExpression: "customerName = 'ABC Corp'"
            searchOptions:
              maxChunks: 10
              mergeContents: true
              threshold: 0.8
          response:
            body:
              searchId: 76b534be-5d5c-11ee-b268-87f1fd934c81
              results:
                - documentId: 82e4b12a-6990-45d4-8ebd-85c00e030c24
                  documentName: "ABC Corp - Initial meeting transcript"
                  documentMetadata:
                    customerName: "ABC Corp"
                    meetingDate: "2021-01-01T00:00:00Z"
                  chunks:
                    - chunkId: 8d49fa7e-f09a-4bd4-ae94-4c089c9043a0
                      chunkIndex: 0
                      text: "Lorem ipsum dolor sit amet, consectetur adipiscing elit"
                      score: 0.9
                    - chunkId: c24f99f9-2477-461b-8f8f-90a82a40879d
                      chunkIndex: 1
                      text: "Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore"
                      score: 0.8
                    - chunkId: 6413d18c-b37f-4985-9045-cc8d6e100a17
                      chunkIndex: 2
                      text: "sunt in culpa qui officia deserunt mollit anim id est laborum."
                      score: 0.7
                  mergedContents: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore. sunt in culpa qui officia deserunt mollit anim id est laborum.
                  customMetadata: {}
                - documentId: 90998ceb-1c10-4d2a-96cb-acf89fa3005e
                  documentName: "XYZ Corp - Follow-up transcript"
                  documentMetadata:
                    customerName: "XYZ Corp"
                    meetingDate: "2021-01-02T00:00:00Z"
                  chunks:
                    - chunkId: 3664912a-3edb-4d88-b624-80db99d383e6
                      chunkIndex: 0
                      text: "Lorem ipsum dolor sit amet, consectetur adipiscing elit"
                      score: 0.7
                    - chunkId: da9d43a4-2927-442c-8e5c-b9ef86f56fc3
                      chunkIndex: 1
                      text: "Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore"
                      score: 0.9
                    - chunkId: 8d882e9f-8eda-479b-ae2a-359ebae7b626
                      chunkIndex: 2
                      text: "sunt in culpa qui officia deserunt mollit anim id est laborum."
                      score: 0.75
                  mergedContents: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore. sunt in culpa qui officia deserunt mollit anim id est laborum.
                  customMetadata: {}
    submitSearchFeedback:
      path: /submitSearchFeedback
      docs: Submit end-user feedback on a search result to be persisted on the audit log
      method: POST
      request:
        name: SubmitSearchFeedbackRequest
        body:
          properties:
            searchId:
              type: uuid
              docs: |
                UUID of the search response that this feedback is for
            feedback:
              type: Feedback
            userEmail:
              type: optional<string>
            comments:
              type: optional<string>
      response: SubmitSearchFeedbackResponse
      examples:
        - name: submitSearchFeedback
          request:
            searchId: 82e4b12a-6990-45d4-8ebd-85c00e030c24
            feedback: "THUMBS_UP"
            userEmail: "ben@credal.ai"
            comments: "There's something relevant about 2FA in the document that wasn't included in the search results"
          response:
            body:
              auditLogId: 13c18750-5bc1-11ee-a8d5-733be8e2f38c
types:
  CatalogSearchOptions:
    properties:
      maxResults:
        type: optional<integer>
        docs: |
          The maximum number of results to return. Defaults to 10.
      searchContents:
        type: optional<boolean>
        docs: |
          Whether to search the contents of the document. Defaults to false.
  SearchDocumentCatalogResponse:
    properties:
      searchId: uuid
      results: list<CatalogSearchResult>
  CatalogSearchResult:
    properties:
      documentId: uuid
      documentName: string
  DocumentCollectionSearchOptions:
    properties:
      maxChunks:
        type: optional<integer>
        docs: |
          The maximum number of chunks to return. Defaults to 10.
      mergeContents:
        type: optional<boolean>
        docs: |
          Whether to merge the chunks for a document and just return one result per document. Defaults to false.
      threshold:
        type: optional<double>
        docs: |
          The similarity threshold between 0 and 1 for the search results. A higher number leads to fewer but more relevant results. 
          Defaults to 0.75.
  SearchDocumentCollectionResponse:
    properties:
      searchId: uuid
      results: list<DocumentCollectionSearchResult>
  DocumentCollectionSearchResult:
    properties:
      documentId: uuid
      documentName: string
      documentMetadata: map<string, string>
      customMetadata: optional<commons.MetadataSchema>
      chunks: list<SearchResultChunk>
      mergedContents: optional<string>
  SubmitSearchFeedbackResponse:
    properties:
      auditLogId: uuid
  SearchResultChunk:
    properties:
      chunkId: uuid
      chunkIndex: integer
      text: string
      score:
        type: double
        docs: |
          The similarity score between 0 and 1 for the search result. A higher number means the chunk is more relevant to the search query.
  Feedback:
    enum:
      - THUMBS_UP
      - THUMBS_DOWN
